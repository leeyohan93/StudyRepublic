<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<!-- 	layout:decorate="~{/layout/mainLayout}"> -->
<head>
<meta charset="UTF-8">
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
<!-- default header name is X-CSRF-TOKEN -->
<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/>
<title>회원정보 수정페이지</title>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="http://dmaps.daum.net/map_js_init/postcode.v2.js"></script>




</head>
<body>


 <span sec:authentication="principal.member.nickname"></span>님 회원정보 수정페이지  <br>
<div th:each="md : ${mdu}">
 <div>
 	<b>프로필사진</b> 
 	<form name="image_Form" id="image_Form" action="attachments" method="post">
 	<img id="img_profile" th:src="@{'/member_image/'+${md.profileSaveName}}" style="width:200px; height:200px"/>
	<br>
	<input name="sourceFile" id="sourceFile" type="file">
	
	<input type="button"  id="newimg_upload" name="newimg_upload" value="이미지변경"/>
	</form>
	
	<form name="basicimage" action="setdefault_img">
		<input type="submit"value="기본이미지로 변경"/>
	</form>
	
 </div>
 <span>	<a class="btn btn-primary" id="modifypwd" th:href="@{passwordmodi}" role="button">비밀번호 변경</a></span>
 
 <form th:action="@{modimember2}" name="form1" method="post">

 	ID&nbsp&nbsp<span th:text="${md.id}"></span></br>
 	비밀빈호&nbsp&nbsp<span><input type="password" id="passwordcheck" name="passwordcheck"/></span></br>
 	이름&nbsp&nbsp<span th:text="${md.name}"></span></br>
 	성별&nbsp&nbsp<span th:text="${md.gender}"></span></br>
 	생년월일&nbsp&nbsp<span th:text="${md.birth}"></span></br>
	닉네임&nbsp&nbsp<span th:text="${md.nickname}"></span></br>
	이메일&nbsp&nbsp<span><input type="text" id="email" name="email" th:value="${md.email}"/></span>&nbsp&nbsp
	<button type="button" class="button" id="emailcheck" name="emailcheck" >중복체크</button></br>
	<div id="checkmsg"></div>
	휴대폰번호&nbsp&nbsp<span><input type="text" name="phonenumber" th:value="${md.phonenumber}"/></span>
	<button type="button" class="button" onclick="check()">인증번호</button></br>
	인증번호&nbsp&nbsp&nbsp<span><input type="text" name="phonenumber2"/></span>
	<button type="button" class="button" onclick="check()">완료</button></br>
	공개여부&nbsp&nbsp&nbsp<span><input type="radio" name="visibility" value="0"/>공개&nbsp&nbsp<input type="radio" name="visibility" value="1"/>비공개</span>
	<input type="hidden" id="hidden_visibility" th:value="${md.visibility}"/>
</div>
<br>
<span>	<a class="btn btn-primary" id="memberexit" th:href="@{memberexit}" role="button">탈퇴하기</a></span>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> 
<span>	<a class="btn btn-primary" id="complate" role="button">완료</a></span>



</form>
	

 <script type="text/javascript">
 var token = $("meta[name='_csrf']").attr("content");
 var header = $("meta[name='_csrf_header']").attr("content");
 $(function() {
     $(document).ajaxSend(function(e, xhr, options) {
         xhr.setRequestHeader(header, token);
     });
 });
$(document).ready(function(){

	var sel_file;
	var data = {};
	var emailcheck =0;
	var complate = 0;
	var email = "";
	var visibilityValue = '0'; //공개 일때 0 비공개는 1 
	
	visibilityValue = $('#hidden_visibility').val();
	
	if(visibilityValue == '0' || visibilityValue == '1'){
		$('input:radio[name=visibility]:input[value=' + visibilityValue + ']').attr("checked", true);
	}
	
	//임시로 수정하기 완료버튼 이벤트
	/* $("#complate").click(function(){
		if(confirm("수정하시겠습니까?")){
		}
		
		
		document.form1.submit();
		
	});
	  */
	//이미지 미리보기
	$("#sourceFile").on("change",handleImgFileSelect);
	  
	  function handleImgFileSelect(e){
		  var files = e.target.files;
		  var filesArr = Array.prototype.slice.call(files);
		  
		  filesArr.forEach(function(f){
		  	if(!f.type.match("image.*")){
		  		alert("확장자는 이미지 확장자만 가능합니다.");
		  		return;
		  	}
		  
		  	sel_file = f;
		  	
		  	var reader = new FileReader();
		  	reader.onload = function(e){
		  		$("#img_profile").attr("src",e.target.result);
		  	}
		  	reader.readAsDataURL(f);
		  		
		  });
	  }
	//이미지업로드
	// form 값 전부 보내기
	$('#newimg_upload').click(function(){
	  
	    var idx = $(this).parent().parent().index();
	    var frm = document.getElementById('image_Form');
	    frm.method = 'POST';
	    frm.enctype = 'multipart/form-data';
		
	    var fileFormValue = $('#sourceFile').val();
	    
	    var fileData = new FormData(frm);
	  	
	    console.log("fileData:" + fileFormValue);
	    if(fileFormValue != null && fileFormValue != {} && fileFormValue != ''){
		    // ajax
		    $.ajax({
		        url:'/attachments',
		        type:'POST',
		        data:fileData,
		        async:false,
		        cache:false,
		        contentType:false,
		        processData:false
		    }).done(function(response){
		        alert("프로필변경이 완료되었습니다.");
		        location.reload();
		    });
	  	}else{
	  		alert("파일이 첨부되지 않았습니다.");
	  	}
	});

	
	//이메일 중복체크
	var data ={};
	
	$("#emailcheck").click(function(){
		data.email = $("#email").val();
		data.url = "./emailAuth";
		sendServer(data);
	});
	function sendServer(data){
		
		$.ajax({
			type:"get",
			url:data.url,
			data : data, //{email : $("#email").val()}
			datatype:"JSON",
			success:function(success){
				console.log(success);
				if(success.emailCount == 0){
					alert("이메일이 중복되지 않습니다.");
				}else{
					alert("이메일이 중복되었습니다.");
				}
			},
			error:function(error){
				console.log(error);
			}
			
		});
}
 	//완료버튼 클릭시 비밀번호입력하기
	$("#complate").click(function(){
		data = {};
		data.password = $("#passwordcheck").val();
		data.url = "./passwordAuth";
		complete(data);
	});
	
	function complete(data){
		$.ajax({
			type:"POST",
			url:data.url,
			data : data,
			datatype:"JSON",
			success:function(eee){
				console.log(eee);
			if(confirm("수정하시겠습니까?")){
					
					document.form1.submit();
				} 
			},
			error:function(sss){
				console.log(sss);
			}
			
		});
	}
		 


});
	
</script>


</body>
</html>



<!-- 	<article>
		<h3> <span sec:authentication="principal.member.nickname"></span>님이 접속중입니다. </h3><br>
		<a href="">비밀번호변경</a>
		<div class="profile">프로필 사진</div>


		<div class="modify_top" name="top">
		<tr th:each="mdu : ${mdu}">
		
				<br>아이디
				<td th:text=${mdu.id}/><br>

				<br>비밀번호 &nbsp&nbsp
				<input type="password" name="pwd" id="pwd" />
				
				<br>&nbsp&nbsp&nbsp이름 &nbsp&nbsp&nbsp&nbsp
				<td th:text=${mdu.name}/><br>
				
				<br><tr>&nbsp&nbsp닉네임 &nbsp&nbsp&nbsp</tr>
				<td th:text=${mdu.nickname}></td><br>
				
				<br>생년월일 &nbsp&nbsp
				<td th:text=${mdu.birth}/><br>
					<form name="top">
						E-mail&nbsp&nbsp
						 <input type="text" name="email1" id="email1" value="" /> 
						 <input type="text" name="email2" id="email2" value="" disabled /> 
						 <select name="email3" id="email3" onchange="email_change()">
							<option value="0">선택하세요.</option>
							<option value="9">직접입력</option>
							<option value="@naver.com">네이버</option>
							<option value="@hanmail.net">다음</option>
							<option value="@google.co.kr">구글</option>
						</select>
						<button value="button">중복체크</button>
					</form> 
					<br>&nbsp휴대폰번호 
					<input type="text" name="phonenumber" id="phonenumber"></input>
					<button value="button">인증번호받기</button>
					 <br>&nbsp 인증번호 
					 <input type="text" name="phonenumber" id="phonenumber"></input>
					<button value="button">확인</button> 
					
					<br>&nbsp 공개여부&nbsp
					<input type="radio" id="open1" name="open" value="공개" checked="checked">
					</input> 
					<label for="open1" class="aaa">공개</label> 
					
					<input type="radio" id="open2" name="open" value="비공개" checked="checked"></input>
					 <label for="open2" class="bbb">비공개</label> <br>
					
					<button type="button" href="">탈퇴하기</button> <br>
					<button type="submit">완료</button>
			
		  </tr>	
		</div>




	</article>
	
	
 -->




