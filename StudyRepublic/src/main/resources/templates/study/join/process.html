<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
layout:decorate="~{/layout/mainLayout}"><head>
<meta charset="UTF-8">

<!-- Spring Security ~ Ajax 관련 추가 코드 BY 성호님 -->
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}" />

<title>스터디 가입</title>
</head>

<th:block layout:fragment="customCss">
	<style>
	
/* 	.leveltest-container { */
/* 		padding: 0.3rem; */
/* 		background-color: silver;	 */
/* 	} */
	
/* 	.leveltest { */
/* 		opacity: 0.4 !important; */
/* 		border-radius: 22.37%; */
/* 	} */
	
		#main {
		    background: white !important;
		}
	
        /********************************** leveltest - CSS 시작 **********************************/
        #leveltestArea .leveltest-container {
            width: 100%;
            float: left;
			/* padding-bottom: 100px; */
            /* 참고:  https://stackoverflow.com/a/34471088 */
            /* 문제:  .leveltest-toggle 을 더블클릭하면 컨테이너 내부의 텍스트가 셀렉트 되는 문제 발생 */
            /* 해결:  아래의 스타일을 추가함. (본문 4줄에 해당하는 내용) */
            /* 한계:  텍스트를 셀렉트 해야 할 경우에도 선택되지 않는 경우를 고려해보았으나, 어차피 sortable 적용으로 인해 선택이 불가하며 레벨테스트 취지에도 맞지 않으므로 아래처럼 적용하기로 함. */
            /* 추가:  $(".leveltest-container").on('dbclick', function(e) { e.preventDefault(); return false; }); 처럼 script 단에서 처리하는 방법도 있음. */
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            display: block;
            margin-top: 2em;
            border: solid 1px silver;
            padding: 0.5em;
            min-height: 400px;
             background-image: url("/images/background/background_mountain.jpg");
/*             background-image: url("/resources/static/images/bgimg/background-gradient-skypink.jpg"); */
/* 			background-color: skyblue; */

            background-size: cover;
/*    			background-position-y: -230px; */
        }

        #leveltestArea .leveltest {
            margin: 0 0 0.5em 0;
            padding: 0.3em;
/*             border: 1px solid #c5c5c5; */
           	border-radius: 11.5px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: unset !important;
            opacity: 0.86;
/*             background: transparent\9;   */
/*     		background:rgba(0,0,0,0.4);   */
            
        }

        #leveltestArea .leveltest-placeholder {
/*             border: 1px dotted black; */
            margin: 0 0 1em 0;
            height: 50px;
            
        }

        #leveltestArea input:not(#leveltest-rewrite-btn), #leveltestArea select {
		    background-color: #e6e4de !important;
		    border: none !important;
		    display: inline-block;
		    height: auto;
    		border-radius: 5px;
 		    padding: 0.6em 1em;
         }
        
        #leveltestArea input:focus {
            background-color: transparent;
            border: dotted 1px;
            display: inline-block;
            height: auto;
        }
		
        #leveltestArea input.question-content {
            vertical-align: middle;
            font-weight: 350 !important;
        }

        #leveltestArea input.question-edit {
            width: 84%;
            font-size: 0.95rem;
        }

/*         #leveltestArea input.question-choice-group { */
		#leveltestArea .question-choice-group {
            margin-bottom: 0.3rem !important;
        }

        #leveltestArea input.question-choice-option {
            width: 80%;
            height: 1.6em;
            font-size: 0.85rem;
        }

        #leveltestArea .question {
            padding: 0.5em 0.9em;
		    margin-bottom: 0.9em;
            position: relative;
/*             border: 1px solid #dddddd; */
/*             background: #e9e9e9; */
			border: none;
			background: rgba(255, 255, 255, 0.65);
			opacity: 0.9;
            color: #333333;
            font-weight: bold;
        	border-top-left-radius: 11.5px; 
			border-top-right-radius: 11.5px;
        }

        #leveltestArea .question-numbering {
            display: inline-block;
            vertical-align: top;
            height: 100%;
            border: none;
            width: 1.3em;
            font-weight: bolder;
            font-size: 1.3rem;
        }

        #leveltestArea .question-content {
            display: inline-block;
            line-height: 2em;
            width: 80%;
            margin-right: 20px;
            padding-block-end: 1px;
            padding-block-start: 1px;
            padding-bottom: 1px;
            padding-top: 1px;
            font-weight: 350 !important;
        }

        #leveltestArea .question-edit {
            font-family: "Malgun Gothic";
            font-size: 1rem;
            color: #333333;
            font-weight: bold;
        }

        #leveltestArea .leveltest-toggle {
            position: absolute;
            top: 1.5rem;
    		right: 0.5rem;
            transform: translateY(-60%);
        }

		#leveltestArea .icon::before {
			font-size: 0.8rem !important;
			color: #495057 !important;
			font-weight: lighter !important;
			
		}
		
        #leveltestArea .icon-minus::before {
/*             content: "\f068"; */
/*             font-family: "Font Awesome 5 Free"; */
/*             font-weight: 600; */
/*             color: black; */
            width: 100%;
            padding: 0.2em 0.3em;
            
            content: "간략히 보기"; 
        }

        #leveltestArea .icon-plus::before {
/*             content: "\f067"; */
/*             font-family: "Font Awesome 5 Free"; */
/*             font-weight: 600; */
/*             color: black; */
            width: 100%;
            padding: 0.2em 0.3em;
            
/* 			font-size: 2rem !important; */
/* 			color: #0082ff; */
/* 			content: "+"; */
			content: "더 보기";
						
        }

        #leveltestArea .question-choice {
/*             padding: 0.4em; */
        }
        #leveltestArea .question-choice-group {
        	padding-left: 2rem;
        }

        #leveltestArea .choice-numbering {
            margin-right: 0.5rem;
            margin-left: 1rem;
            font-weight: 640;
		    font-size: 1.1em;
        }

        #leveltestArea .choice-numbering:after {
            content: ")";
        }

        #leveltestArea .icon-remove {
            display: none;
        }

        #leveltestArea .icon-remove:hover {
            cursor: pointer;
        }

        #leveltestArea .icon-remove:after {
            content: "\F00D";
            font-family: "Font Awesome 5 Free";
            font-weight: 600;
            color: black;
            font-size: 0.8rem;
            vertical-align: middle;
            margin-left: 5px;
        }

        #leveltestArea .question-choice-placeholder {
            border-radius: 10px;
            background-color: grey;
            margin-left: 2rem;
            padding: 0.2rem 0.7rem;
            width: auto;
            display: inline-block;
            vertical-align: middle;
            font-size: 0.7em;
            font-weight: bold;
            color: white;
        }

        #leveltestArea .question-answer {
            font-size: 0.9em;
            margin-left: 3em;
/*             margin-bottom: 1.6em; */
/* 		    padding-bottom: 1.08rem; */
            
        }

        #leveltestArea .question-choice~.question-answer {
            margin-left: 83%;
        }

        #leveltestArea input.question-answer-input {
            width: 80%;
            margin-left: 0.25em;
        }
        
        #leveltestArea select {
            width: 4rem;
            margin-left: 10px;
            background-position: calc(100% - 0.5rem) center !important;
            
        }

        #leveltestArea .inline-block {
            display: inline-block;
        }
		
		#leveltestArea .leveltest-btn-container {
			margin: 0 16%;
			
		}
		
		#leveltestArea .join-form-btn {
		    margin: 0 1rem !important;
		}
		
/* 		#leveltestArea .leveltest-footer { */
/* 		    font-size: 0.9em; */
/* 		    color: #343a40; */
/* 		    text-align: center; */
/* 		    padding-bottom: 0.5em; */
/* 		    letter-spacing: 1em; */
/* 		} */

        /********************************** leveltest - CSS 끝 **********************************/
        
        .point-form {
            background-color: #f7f7f7;
   			padding: 50px;
   			margin-top: 20px;
   			margin-bottom: 20px;
        }
        
        .label-checkbox100 {
        	font-size: 18px !important;
       	    font-weight: 900 !important;
       	    cursor: default !important;
       	    display: inline-block !important;
       	    position: absolute !important;
        }
        
        .label-checkbox100::before {
         	content: '\f0c8' !important; 
             font-family: "Font Awesome 5 Free" !important; 
             border: none !important; 
             color: #999999 !important; 
             background: none !important; 
             background-color: none !important; 
             font-size: 0.3rem !important; 
        }
	
		.point-amount {
			display: inline-block;
		    margin-left: 85%;
		    text-align: right;
		    width: 5rem;
		}
		
		.join-form-btn {
		    display: inline-block !important;
		    width: auto !important;
		    height: auto !important;
		    margin: auto !important;
		}
		
		input[id='leveltest-rewrite-btn'] {
			border: none !important;
			font-size: 12px !important;
			background: none !important;
		}
		
		.disabled {
			background-color: #ccc !important;
			color: silver !important;
		}
		
		.disabled #point-pay-btn:hover {
			color: silver !important; 
			box-shadow: none !important;
			cursor: default !important;
		}
		
		.alert-msg {
		    width: 100%;
		    font-size: 10px;
		    display: block;
		    padding-bottom: 12px;
		    color: red;
		}
	
	</style>
	
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
	
	<!-- Sortable (for leveltest) -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

	<!-- 성호님 소스 -->	
	<link rel="stylesheet" type="text/css" href="/Login_v18/css/main.css">
	
</th:block>

<body>


	<div layout:fragment="main">
		<div class="inner">
		
			<form id="join-form" action = "/study/joinConfirm" method = "post">
					            
 				<input type='hidden' th:name='${_csrf.parameterName}' th:value='${_csrf.token}' />
            	
				<section class="leveltest-section" th:if="${leveltestList}">
				
					<div class="page-header">
						<div class="page-title">
							<h4>레벨테스트</h4>
							<hr>
						</div>
						<div class="page-description">
							<p>
							-	신청하신 스터디에는 레벨테스트가 등록되어 있습니다.<br/>
							-	레벨테스트 응시는 선택사항입니다.<br/>
							-	응시 결과는 리더가 가입 승인을 검토할 때 참고 자료로 사용됩니다.<br/>
							-	주의! 제출하기 버튼을 클릭하면 빈 답안이 제출되어 오답 처리 됩니다.
							</p>			
						</div>
					</div>
					
					<div class="page-content" id="leveltestArea">
						
						
				            <div class="leveltest-container">
		
				            
					            <th:block th:each="leveltest : ${leveltestList}">	
					            
					            
		<!-- 			            	<th:block th:if="${leveltest.leveltestTypeCode.leveltestTypeCode} == 'MC'"> -->
							            <div class="leveltest" th:if="${leveltest.leveltestTypeCode.leveltestTypeCode} == 'MC'">
						       		        <input type="hidden" name="leveltestId" th:value="${leveltest.leveltestId}">
						       		        <input type="hidden" name="studyId" th:value="${studyId}">
            								<input type="hidden" name="id" th:value="${id}">
							                <div class="question">
							                    <span class="numbering question-numbering" th:text="${leveltest.questionNumber}">number</span>
							                    <span class="question-content" th:text="${leveltest.content}">content</span>
							                    <span class='icon icon-plus leveltest-toggle'></span>
							                </div>
							                
							                <!-- 참고:  https://bestcure.tistory.com/entry/thymeleaf-each-%EB%AC%B8-%EC%95%88%EC%97%90%EC%84%9C-split%EC%9C%BC%EB%A1%9C-%ED%95%9C%EB%B2%88%EB%8D%94-each-%EC%98%88%EC%A0%9C -->
							                <div class="question-choice" style="display: none" th:each="choice : ${#strings.arraySplit(leveltest.choice, ';')}">
							                
							                    <div class="question-choice-group">
							                        <span class="numbering choice-numbering" th:text="${choiceStat.index} + 1">0</span>
							                        <span class="question-choice-option" th:text="${choice}">choice</span>
							                    </div>
<!-- 							                    <hr> -->
							                    
							                </div>
							                
							                <div class="question-answer" style="display: none">
							                    	정답: <select name="submitAnswer">
							                    	<option value=""></option>
							                        <option th:each="choice : ${#strings.arraySplit(leveltest.choice, ';')}" th:value="${choiceStat.index} + 1" th:text="${choiceStat.index} + 1">0</option>
							                    </select>
							                    <input type="hidden" id="correctAnswer" th:value="${leveltest.correctAnswer}">
						                    	<input type="hidden" name="isCorrect">
							                </div>
							                <div class="leveltest-footer">&nbsp;</div>
							            </div>
		<!-- 							</th:block> -->
										
		<!-- 			           		<th:block th:if="${leveltest.leveltestTypeCode.leveltestTypeCode} == 'SA'"> -->
				                        <div class="leveltest" th:if="${leveltest.leveltestTypeCode.leveltestTypeCode} == 'SA'">
									      	<input type="hidden" name="leveltestId" th:value="${leveltest.leveltestId}">
				                            <input type="hidden" name="studyId" th:value="${studyId}">
            								<input type="hidden" name="id" th:value="${id}">
				                            <div class="question">
				                                <span class="numbering question-numbering" th:text="${leveltest.questionNumber}">0</span>
				                                <span class="question-content" th:text="${leveltest.content}">content</span>
				                                <span class="icon icon-plus leveltest-toggle"></span>
				                            </div>
				                            <div class="question-answer" style="display: none">
												정답: <input name="submitAnswer" class="question-answer-input" type="text">
												<input type="hidden" id="correctAnswer" th:value="${leveltest.correctAnswer}">
							                    <input type="hidden" name="isCorrect">
				                            </div>
				                            <div class="leveltest-footer">&nbsp;</div>
				                        </div>
									
		<!-- 							</th:block> -->
								
								</th:block>
								
							</div>
							
							<div>&nbsp;</div>
							
							<div class="leveltest-btn-container">
								<div class="join-form-btn reset-btn">
									<input type="reset" id="leveltest-rewrite-btn" value="다시 작성하기"></button>
								</div>
								<div class="join-form-btn">
									<button type="button" id="leveltest-submit-btn">답안 제출</button>
								</div>
								<div class="join-form-btn">
									<button type="button" id="leveltest-skip-btn">건너뛰기</button>
								</div>
							</div>
						
						
					</div>
					
				</section>
				
				<section class="pay-section" th:if="${memberPoint}">
				
					
					<div class="page-header">
						<div class="page-title">		
							<h4>포인트 결제하기</h4>
							<hr>
						</div>
						<div class="page-description">
							<p>-	본 스터디는 프리미엄 스터디로, 신청 시 포인트가 차감됩니다.</p>
						</div>
					</div>
						
					<div class="page-content" id="payArea">
						
						<div class="point-form">			
							
							<span class="point-title label-checkbox100">보유 포인트</span>
							<div class="point-amount">
								<span id="current-point" th:text="${memberPoint.point}">-</span>P
							</div>
							
							<hr/>
							
							<span class="point-title label-checkbox100">결제 예정 포인트</span>
							<div class="point-amount">
								<span id="pay-point" th:text="${study.price.price}">-</span>P
							</div>
							
							<hr/>
							
							<span class="point-title label-checkbox100">차감 후 포인트</span>
							<div class="point-amount">
								<span id="after-point" th:text="${memberPoint.point - study.price.price}">-</span>P
							</div>
							
							<hr/>
							
							<div id="pay-alert-container" style="display:none;">
								<span id="pay-alert-msg" class="alert-msg">
									포인트가 부족합니다!<br/>
									스터디를 신청하려면 포인트를 충전하세요.
								</span>
							</div>
							
							<div class="pay-btn-container">
								<div class="join-form-btn">
									<button type="button" id="point-charge-btn">충전하기</button>
								</div>
								<div class="join-form-btn">
									<button type="button" id="point-pay-btn">결제하기</button>
<!-- 									<button type="submit" id="point-pay-btn">결제하기</button> -->
								</div>
							</div>
							
						</div>
					</div>
					
					<input type="hidden" name="price" th:value="${study.price.price}">
					<input type="hidden" name="pointid" th:value="${memberPoint.pointid}">
				
				</section>
				
            	<!-- 값이 공통으로 들어가는지 확인할 것 -->
            	<input type="hidden" name="studyId" th:value="${studyId}">
            	<input type="hidden" name="id" th:value="${id}">
				
			</form>
			
		</div>
	</div>

	<th:block layout:fragment="customScript">
		<script type="text/javascript" th:inline="javascript">
		/* <![CDATA[ */       

			
			var studyId = /*[[${study.studyId}]]*/;
			var childWindowObj;
		
			<!-- Spring Security ~ Ajax 관련 추가 코드 BY 성호님 - 시작 -->
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			
			$(function() {
				$(document).ajaxSend(function(e, xhr, options) {
					xhr.setRequestHeader(header, token);
				});
			});
			<!-- Spring Security ~ Ajax 관련 추가 코드 BY 성호님 - 끝 -->
			

			
			$(document).ready(function() {
				
				enableToggle();
				beforeSubmit();
				
				console.log('studyId = ' + studyId);
				
				if($('.leveltest-section')[0] != null) {
					$('.pay-section').css('display', 'none');
				}
				
			});
			
			
	        function enableToggle() {
	            
	            $(".leveltest-container").on("click", ".leveltest-toggle", function () {
	            	
                    var icon = $(this);

                    icon.toggleClass("icon-plus icon-minus");
                    icon.closest(".leveltest").find(".question-choice, .question-answer").slideToggle();

            	});
	            
	        }
	            
	            
	        function beforeSubmit() {
	        	
	        	
	        	// 1. 레벨테스트
				$('.leveltest-btn-container .join-form-btn:not(.reset-btn)').on('click', function() {

					console.log($(this));
					
					var targetBtn = $(this).find("button").attr("id");  
					
					switch(targetBtn) {

						case "leveltest-submit-btn":
							
							var $answer;
							var submitAnswer;
							var correctAnswer;
							var isCorrect;
							
							for(var i=0; i<$('.leveltest').length; i++) {
								$answer = $($('.leveltest')[i]).find('.question-answer');
								submitAnswer = $answer.find("[name='submitAnswer']").val();
								correctAnswer = $answer.find("[id='correctAnswer']").val();
								isCorrect = (submitAnswer == correctAnswer)? 1 : 0;
								$answer.find("[name='isCorrect']").val(isCorrect);
							}
							// json 등 객체로 만들어서 스크립트단에 보관할 수 있나?
							// null 값 들어가는지 확인할 것
							
							$(".leveltest").each(function (index) {
								
			                    $(this).find("input[name='leveltestId']").attr("name", "leveltestResponseList[" + index + "].leveltestResponseId.leveltestId");
			                    $(this).find("input[name='studyId']").attr("name", "leveltestResponseList[" + index + "].leveltestResponseId.studyMemberId.studyId");
			                    $(this).find("input[name='id']").attr("name", "leveltestResponseList[" + index + "].leveltestResponseId.studyMemberId.id");
			                    $(this).find("[name='submitAnswer']").attr("name", "leveltestResponseList[" + index + "].submitAnswer");
			                    $(this).find("input[name='isCorrect']").attr("name", "leveltestResponseList[" + index + "].isCorrect");
			                    
// 			                    $(this).find("input[name='leveltestId']").attr("name", "leveltestResponseList[" + index + "].leveltestId");
// 			                    $(this).find("input[name='studyId']").attr("name", "leveltestResponseList[" + index + "].studyId");
// 			                    $(this).find("input[name='id']").attr("name", "leveltestResponseList[" + index + "].id");
// 			                    $(this).find("[name='submitAnswer']").attr("name", "leveltestResponseList[" + index + "].submitAnswer");
// 			                    $(this).find("input[name='isCorrect']").attr("name", "leveltestResponseList[" + index + "].isCorrect");
			                    
			                    console.log($(this).find("[name*='leveltestResponseList']"));
			                });
			                
							break;
							
						case "leveltest-skip-btn":
							
							$('.leveltest-container').remove();	
							
							break;
					
					}
// 					if($('.pay-section') == null) {	//오류
					if($('.pay-section').length == 0) {
						
						submitForm();
		                
					}
					
					$('.leveltest-section').css('display', 'none');
					$('.pay-section').css('display', 'block');
					
				})
	        	
				
				// 2. 포인트 결제
				$('.pay-btn-container .join-form-btn').on('click', function() {
					
					var thisBtn = $(this).find('button').attr('id');
					
					switch(thisBtn) {
					
						case "point-pay-btn":
							if( $($('#current-point')[0]).text()-0 < $($('#pay-point')[0]).text()-0 ) {
								$('#point-pay-btn').parent().addClass('disabled');
								$('#pay-alert-container').show();
								
								return false;
								
							} else {
// 								$('#point-pay-btn').parent().removeClass('disabled');
// 								$('#pay-alert-container').hide();
								
								submitForm();

							}
							break;
							
						case "point-charge-btn":
							
							var needPoint = $('#pay-point').text(); 
							// https://rongscodinghistory.tistory.com/33, https://all-record.tistory.com/149, https://ggmouse.tistory.com/233
							
							window.name = "joinProcess";
							childWindowObj = window.open("/member/point/charge?indicator=min&needPoint=" + needPoint, "chargePoint", "width=450px, height=902.391px, resizable = no, scrollbars = no");
							
							break;
							
					}
					
				});
				
	        }
	
	        function resetPointInfo() {
	        	$.ajax({
	        		type: 'POST'
// 	        		, data: {"studyId": studyId}
	        		, url: '/study/memberPointInquiry'
	        		, success: function(data) {
	        			console.log('ajax 성공');
// 	        			console.log(data);
	        			
	        			if(data.point != null) {
	        				console.log("not null data");
	        				var newPoint = data.point - 0;
	        				var payPoint = $('#pay-point').text() - 0;
	        				var afterPoint = newPoint - payPoint;
	        				$('#current-point').text(newPoint);
	        				$('#after-point').text(afterPoint);	
	        				
	        				if(afterPoint < 0) {
								$('#point-pay-btn').parent().addClass('disabled');
								$('#pay-alert-container').show();
								
	        				} else {
								$('#point-pay-btn').parent().removeClass('disabled');
								$('#pay-alert-container').hide();
	        				}
	        			}
	        			
	        		}
	        		, error: function(e) {
	        			console.log("Error: " + e);
	        			return false;
	        		}
	        		
	        	})
	        	
	        }
	        
	        function submitForm() {
//                 $("form").attr("action", "/study/joinConfirm");
//                 $("form").attr("method", "post");
//                 $("form")[0].submit();	// 참고:	https://stackoverflow.com/q/22982741
                $("#join-form").submit();
	        }
			
	        /* ]]> */
		</script>
	</th:block>
</body>
</html>