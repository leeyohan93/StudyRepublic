<!-- 
  @author 윤원식
  @since 2019. 2. 2.
  @version
  -viewInquireBaord.html 이름 변경
 -->

<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/mainLayout}">
<head>

<title>게시판 글목록</title>
<meta http-equiv="Content-Type" content="text/html" ; charset="utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
<meta id="_csrf_header" name="_csrf_header"
	th:content="${_csrf.headerName}" />
<script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	
<style>
#beforeAfter {
	padding: 0px !important;
	margin: 1px;
}
#viewForm {
	border: 1px solid #ccc;
}
#goBeforeInquirePage, #goAfterInquirePage, #likeCountBtn, #viewRepotBtn {
	background-color: white;
	color: rgb(66, 161, 226);
	border: 1px solid;
	text-align: center;
	display: inline-block;
	margin: 0px;
	cursor: pointer;
	padding: 7px 2px 2px 2px;
	width: 75px;
	height: 42px;
}
#viewRow1, #viewRow2 {
	padding: 20px 0px 5px 0px;
	border-bottom: 1px solid #ccc;
}
#viewRow2 {
	border: 0px;
}
#viewTitle {
	font-size: 25px;
}
#boardName {
	font-size: 20px;
}
#titleBar {
	margin: 0px 15px;
}
#chatImgProfile, .commentProfile{
	width: 40px;
	height: 40px;
	border-radius: 100%;
}
#viewBoardId {
	font-size: 18px;
	padding: 10px 10px 0px 0px;
}
#viewBoardHit, #viewBoardDate {
	padding: 10px;
}
.contentArea {
	border: 1px solid #ccc;
	margin-bottom: 20px;
	height: auto;
}
#content {
	resize: none;
	width: 100%;
	height: 400px;
	padding: 12px 13px;
	border-radius: 4px;
	font-size: 18px;
	overflow: auto;
	word-break: break-all;
}
#likeReportForm {
	padding: 10px;
	text-align: center;
}
#likeCountBtn {
	margin-left: 80px;
}
#viewRepotBtn {
	float: right;
}
#viewRow4{
 text-align: right;
 padding: 0px !important;
}
#viewModify,#viewStatus,#boardList,#writeBtn,#boardComment,#inquireComment{
	
	background-color: white;
	color: rgb(66, 161, 226);
	border: 1px solid;
	text-align: center;
	display: inline-block;
	margin: 0px;
	cursor: pointer;
	padding: 7px 2px 2px 2px;
	width: 75px;
	height: 42px;
}
#inquireComment{
float: left;
}
#replyCountForm{
 font-size: 15px;
 padding-left: 20px;
}
.boardReplyForm{
 margin: 5px 20px 20px 20px;
 border: 1px solid #ccc;
}
#commentInsertForm{
margin: 0px;
    height: 90px;
}
.input-group{
}
#registerContent{
    border: 1px solid #ccc;
    margin: 10px;
    overflow: auto;
	word-break: break-all;
	width: 845px;
}
#commentInsertBtn{
	background-color: white;
	border: 1px solid #ccc;
	text-align: center;
	display: inline-block;
    margin-top: 10px;
	cursor: pointer;
	padding: 7px 2px 2px 2px;
	width: 75px;
	height: 60px;
}
.commentArea{
   padding: 10px;
       height: 100px;
}
.commentContent{
resize: none;
    overflow: auto;
	word-break: break-all;
	width: 800px;
	height: 50px;
}
.fileAccordion {
 background-color: white;
  color: rgb(66, 161, 226) !important;
  cursor: pointer;
  font-size: 13px;
  transition: 0.4s;
  float : right;
}
.fileForm{
  display: none;
  text-align: right;
  margin-top: 10px;
}

/* 신고모달 css */
.reportOption{
 text-align: center;
 width: 40%;
 float: left;
 font-weight: bold;
}
#reportBody{
 border: 1px solid #ccc;
 padding: 5px;
}
.reportContent{
text-align: center;
 width: 59.5%;
 float: right;
}
#reportClose{
    padding: 9px;
    height: 40px;
    margin: 0px;
        width: 36px;
}
#reprotContentOption{
    height: 93px;
}
#reportHeader{
padding: 1.5rem 40px 1rem;
font-weight: bold;
}
#reportForm{
margin: 0px;
}
#reportForm input{
 border: 0.5px solid;
 border-radius: 3px;
 margin: 0.6px;
}
#reportForm select{
    border: 1px solid;
    border-radius: 3px;
    height: 50px;
        padding-left: 40px;
}
#reportForm textarea{
height: 90px !important;
    border: 1px solid;
    padding: 10px;
    margin-top: 2px;
    border-radius: 3px;
    text-align: left;
}
#reportCancel,#reportRegister{
 background-color: white;
	color: rgb(66, 161, 226) !important;
	text-align: center;
	display: inline-block;
	margin: 0px;
	cursor: pointer;
	padding: 9px 2px 2px 2px;
	width: 100px;
	height: 50px;
	border: 1px solid ;
	border-radius: 3px;
	margin: 5px;
	font-size: 19px;

}
.commentModifyBtn{
    height: 62px;
    border: 1px solid #ccc;
    margin-left: 10px;
}
#reportRegister{

}
</style>
<body>

	<div id="main" layout:fragment="main">
     

		

		<div class="inner" id="viewForm">
			<!-- 게시글내용 시작 -->
			<!-- 게시판명  -->
			<div id="viewRow1">
				<span name="title" id="viewTitle">[[${inquireBoard.title}]]</span> <span
					id="titleBar">|</span> <span name="boardName" id="boardName">문의게시판</span>

			</div>
			<!--게시판명 끝  -->


			<!--아이디 조회수  날짜  -->
			<div id="viewRow2">
			   <img id="chatImgProfile" th:src="@{'/member_image/'+${inquireBoard.member.profileSaveName}}" />
			   <span id = "viewRow22"> 
			   <span name="id" id="viewBoardId">[[${inquireBoard.member.nickname}]]</span> <span
					name="hit" id="viewBoardHit">조회수&nbsp[[${inquireBoard.hit}]]</span>
				<span name="date" id="viewBoardDate">[[${#dates.format(inquireBoard.date,
				'yyyy-MM-dd HH:mm')}]]</span>
				</span>
				
				 
          
			<!--아이디 조회수 날짜  끝  -->


			<!--글내용 신고  -->
			<div class="contentArea">

				<div name="content" id="content" th:utext="${inquireBoard.content}"
					readonly></div>
				<div id="likeReportForm">
					 <a class="btn"
						role="button" id="viewRepotBtn" data-toggle="modal"
						data-target="#reportModal">신고</a>
				</div>
				<!--글내용 신고 끝  -->
				<!--  댓글  -->
                
				
                <div id="replyCountForm">
				<label for="content">댓글수&nbsp&nbsp<span name="replyCount"
					id="replyCount"></span></label>
					</div>
					
             <div class="boardReplyForm">
             
					<div class="boardReplyList">
						<div class="commentList"></div>
					</div>

					<div class="boardReplySecondList">
						<div class="commentSecondList"></div>
					</div>



					<form id="commentInsertForm" name="commentInsertForm">
						<div class="input-group">
							<input type="hidden" name=inquireBoardId
								th:value="${inquireBoard.inquireBoardId}" /> 
								<input type="hidden"
								name="id" th:value="${memberId}" /> 
								
								<textarea
								type="text" class="form-control" id="registerContent"
								name="content" placeholder="내용을 입력하세요."> </textarea>
								<span class="input-group-btn">
								<button class="btn" type="button"
									id="commentInsertBtn" name="commentInsertBtn">등록</button>
							</span>
									
						</div>
					</form>
				</div>

				<!--댓글끝 -->

			</div>





			<!-- 신고 modal  -->

			<div class="modal fade" id="reportModal" tabindex="-1">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
						  <div>
							<h3 id= "reportHeader">신고하기</h3>
							</div>
							
							<button class="close" id="reportClose" data-dismiss="modal">&times;</button>
						</div>
						<div class="modal-body" id="reportBody" style="text-align: center;">
							<form id="reportForm">
							  <input type="hidden" name = "reportTypeCD" value="inquire">
						
							   <input type="hidden" name = "id" th:value="${memberId}">
							    <input type="hidden" name ="target" id="reportTarget" th:value="${inquireBoard.member.id}">
							<div>
								<input class="reportOption" type="text" value="신고자" readonly>
								<input class="reportContent" name="idNickname" type="text"
									th:value="${session.nickname}" readonly>
									</div>
									<div>
									 <input
									class="reportOption" type="text" value="신고일" readonly>
						<input class="reportContent" name="date" type="text"
									th:value="${#dates.format(inquireBoard.date,'yyyy-MM-dd HH:mm')}"
									readonly> 
									</div>
									<div>
									<input class="reportOption"
									type="text" value="신고대상자" readonly> <input
									class="reportContent" name="targetNickname" type="text"
									th:value="${inquireBoard.member.nickname}" readonly> 
									</div>
									<div>
									 <input
									class="reportOption" type="text" value="신고유형" readonly>
								<select class="reportContent" id="reportWhyCD" name="reportWhyCD">
									<option value="1">영리목적 및 홍보성</option>
									<option value="2">불법정보</option>
									<option value="3">음란성 및 선정성</option>
									<option value="4">욕설 및 인신공격</option>
									<option value="5">개인정보노출</option>
									<option value="6">반복게시 및 도배</option>
									<option value="7">기타</option>
								</select> 
                                 </div>
                                 <div>
 									<input class="reportOption" type="text" value="신고내용" id="reprotContentOption" readonly> <textarea class="reportContent" id="reportContent" name="content" placeholder="신고내용을 작성해주세요."
									></textarea>
									</div>
						</div>
						<div class="modal-footer" id="reportFooter">
							<a class="btn" id="reportCancel" data-dismiss="modal">취소</a>
							<a class="btn" id="reportRegister" data-toggle="model" data-target="#reportConfirm">신고하기</a>
							</form>
						</div>

					</div>
				</div>

			</div>

			<!-- 신고 모달 끝 -->

			

			

			<!-- 게시글 내용 끝 -->


      
		</div>
        </div>
          <!--수정 삭제 목록 글쓰기  -->
			<div class="inner" id="viewRow4">
             <a class="btn btn-default" role="button" id="inquireComment"
						name="inquireComment" th:href="@{'commentBoard'(inquireBoardId=${inquireBoard.inquireBoardId})}">답글</a> 
				<span th:if="${inquireBoard.Id} eq ${memberId}"> <a
					class="btn btn-default" role="button" id="viewModify" name="modify">수정</a>
					<a class="btn btn-default" role="button" id="viewStatus" name="status">삭제</a>
				</span> <a class="btn btn-default" role="button" id="boardList" name="list"
					th:href="@{listInquireBoard}">목록</a> <a class="btn btn-default"
					role="button" id="writeBtn" name="writeBtn" th:href="@{writeBoard}">글쓰기</a>

			</div>
			  
		    
			

			<!--수정 삭제 목록 글쓰기  끝-->
			
			<form id="v1" th:action="@{deleteBoard}" method="get">
				<input type="hidden" name="inquireBoardId"
					th:value="${inquireBoard.inquireBoardId}" /> <input type="hidden"
					name="boardType" value="inquireBoard">
			</form>
			<form id="v2" th:action="@{modifyBoard}" method="get">
				<input type="hidden" name="inquireBoardId"
					th:value="${inquireBoard.inquireBoardId}" /> <input type="hidden"
					name="boardType" value="inquireBoard">
			</form>
        

            <div id="list" layout:fragment="list"></div>





<script th:inline="javascript">
 
		
 //ajax사용하기위한 전역변수
 var token = $("meta[name='_csrf']").attr("content");
 var header = $("meta[name='_csrf_header']").attr("content");
//게시글 번호
 var inquireBoardId = [[${inquireBoard.inquireBoardId}]];
 var likeCount = [[${inquireBoard.likeCount}]];
 $(document).ready(function(){
	  
	 
	 //ajax사용
	 $(document).ajaxSend(function(e, xhr, options) {
         xhr.setRequestHeader(header, token);
     });
	 //페이지 로딩시 댓글 목록 출력 
	 commentList(); 
	});
	 
 //게시판삭제 버튼클릭
 $("#viewStatus").click(function(){
	
	 $("#v1").submit();
	
 });
 //게시판수정 버튼클릭
 $("#viewModify").click(function(){
	$("#v2").submit(); 
 });
 
 //추천 클릭
 $("#likeCountBtn").click(function(){
	 $.ajax({
		 url : '/board/likeCountInquireBoard',
		 type : 'post',
		 data : {'inquireBoardId':inquireBoardId},
	     success : function(data){ 
	    	 if(data != 0){
	    		 $("#likeCount").text(data);
	    		 
	    	 }
	     }
	 });
 });
 
 
 //댓글 등록 버튼 클릭
 $("#commentInsertBtn").click(function(){  
	 //commentInsertForm의 내용을 가져옴
	 var insertData = $("#commentInsertForm").serialize(); 
     commentInsert(insertData); //Insert 함수호출(아래)
 });
 
 //댓글 숫자
 function commentCount(){
	 $.ajax({
		 url:'/comment/commentInquireCount',
		 type :'get',
		 data : {'inquireBoardId':inquireBoardId},
		 success : function(data){ 
			 
			 if(data != 0){
				 $("#replyCount").text(data);
			 }
		 }
				 
	 });
 } 
 
 
 
  
 //댓글 목록 
 function commentList(){
     $.ajax({
         url : '/comment/listInquireReply',
         type : 'get',
         data : {'inquireBoardId':inquireBoardId},
         success : function(data){
             var a =''; 
             $.each(data, function(key, value){    
            	 console.log(value.member.id);
            	
            	 console.log([[${memberId}]]);
                 a += '<div class="commentArea" style="border-bottom:1px solid darkgray; margin-bottom: 15px;">';
                 a += '<div class="commentInfo'+value.inquireBoardReplyId+'"><img class="commentProfile" src="/member_image/'+value.member.profileSaveName+'" > '+value.member.nickname+'&nbsp&nbsp&nbsp'+new Date(value.date).toLocaleString().replace(
          				/([\d]+:[\d]{2})(:[\d]{2})(.*)/, "$1$3"); 
                 if(value.member.id == [[${memberId}]])
                 {
                 a += '<a onclick="commentUpdate('+value.inquireBoardReplyId+',\''+value.content+'\');"> 수정 </a>';
                 a += '<a onclick="commentDelete('+value.inquireBoardReplyId+');"> 삭제 </a>';
                 }
                 a += '</div>';
                 
                 a += '<div class="commentContent'+value.inquireBoardReplyId+'"> <textarea class="commentContent" readonly> '+value.content +'</textarea>';
                 a += '</div></div>';
             });
             commentCount();
             $("#likeCount").text(likeCount);
             $(".commentList").html(a);
         }
     });
 }
  
 //댓글 등록
 function commentInsert(insertData){
     $.ajax({
         url : '/comment/registerInquireReply',
         type : 'post',
         data : insertData,
         success : function(data){
             if(data != 0) {
                 commentList(); 
                 $("#registerContent").val('');
             }
         }
     });
 }
 
 
//댓글 수정 폼생성 
 function commentUpdate(inquireBoardReplyId, content){ 
	 console.log("inquireBoardReplyId = ", inquireBoardReplyId);
     var a ='';
     
     a += '<div class="input-group">';
     a += '<input type="text" class="form-control" name="content_'+inquireBoardReplyId+'" value="'+content+'"/>';
     a += '<span class="input-group-btn"><button class="btn btn-default" type="button" onclick="commentUpdateProc('+inquireBoardReplyId+');">수정</button> </span>';
     a += '</div>';
     
     $('.commentContent'+inquireBoardReplyId).html(a);
     
 }
  
 //댓글 수정
 function commentUpdateProc(inquireBoardReplyId){ 
     var updateContent = $('[name=content_'+inquireBoardReplyId+']').val();
     
     $.ajax({
         url : '/comment/updateInquireReply',
         type : 'post',
         data : {'content' : updateContent, 'inquireBoardReplyId' : inquireBoardReplyId},
         success : function(data){ 
        	 console.log("data = ",data);
             if(data != 0) commentList(inquireBoardId);  
         }
     });
 }
 
  
 //댓글 삭제 
 function commentDelete(inquireBoardReplyId){ 
     $.ajax({
         url : '/comment/deleteInquireReply/'+inquireBoardReplyId,
         type : 'post',
         success : function(data){ 
        	 console.log("data = ",data);
             if(data !=0) commentList(inquireBoardId); 
         }
     });
 }
 

 //첨부파일 토글
  $(".fileAccordion").click(function(){
    $(".fileForm").toggle();
  });
 

  //신고하기
   $('#reportRegister').click(function(){
   var reportData = $("#reportForm").serialize(); 
 	  console.log("reportData:" + reportData);
 	  
 	  if($('#reportTarget').val()==[[${memberId}]]){
 		 Swal.fire("내가 작성한 글입니다.","");
 	  }else if($('#reportWhyCD').val()== ""){
 		 Swal.fire("신고유형을 선택해주세요.","");
 	  }else if($('#reportContent').val()== "" || $('#reportContent').val() == null || $('#reportContent').val() == '&nbsp;'){
 		 Swal.fire("신고내용을 입력해주세요.","");
 	  }
 	  else {
 		  reportInsert(reportData);
 	  }
  }); 

   function reportInsert(reportData){
 	  console.log(reportData);
 	  
 	  $.ajax({
 			url : '/board/report',
 			type :'post',
 			data : reportData,
 			success : function(){
 				console.log("성공");
 				Swal.fire("신고 처리 되었습니다.","");
 				$("#reportModal .close").click()
 			},
 				
 			error :function(){
 				console.log("실패");
 			}
 		});
   };
     </script>
     </div>
    
   </body>
</html>